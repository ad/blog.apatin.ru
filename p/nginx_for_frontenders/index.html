<!doctype html><html class=no-js itemscope itemtype=http://schema.org/Product><head><meta charset=utf-8><title>nginx for frontenders - Weblog</title><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=og:title content="nginx for frontenders - Weblog"><meta property="og:image" content="/static/favicon.png"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><link rel="shortcut icon" href=https://blog.apatin.ru/static/favicon.ico type=image/x-icon><link rel=apple-touch-icon href=https://blog.apatin.ru/static/favicon.ico><link rel=stylesheet href=https://blog.apatin.ru/css/main.min.157c034e55c30a3033be80b8464d3375bb6cb8a04d8ee6c6e102071ec1624345.css integrity="sha256-FXwDTlXDCjAzvoC4Rk0zdbtsuKBNjubG4QIHHsFiQ0U=" media=screen><script type=text/javascript>(function(d,w,c){(w[c]=w[c]||[]).push(function(){try{w.yaCounter21943429=new Ya.Metrika({id:21943429,webvisor:true,clickmap:true,accurateTrackBounce:true});}catch(e){}});var n=d.getElementsByTagName("script")[0],s=d.createElement("script"),f=function(){n.parentNode.insertBefore(s,n);};s.type="text/javascript";s.async=true;s.src=(d.location.protocol=="https:"?"https:":"http:")+"//mc.yandex.ru/metrika/watch.js";if(w.opera=="[object Opera]"){d.addEventListener("DOMContentLoaded",f,false);}else{f();}})(document,window,"yandex_metrika_callbacks");</script><link rel=prev id=link-earlier href=https://blog.apatin.ru/p/monit/><link rel=next id=link-later href=https://blog.apatin.ru/p/postgres_install/></head><body><div class=common><div class=flag><div class=header-content><div class=header-description><div class=title><div class=title-inner><div class=logo-marginal><div class=e2-user-picture-container><img alt=Logo title=Logo src=https://blog.apatin.ru/static/favicon.png></div></div><h1><a href=https://blog.apatin.ru/><span id=e2-blog-title style=font-size:48px>Weblog</span></a></h1></div><div id=e2-blog-description><p>Личный блог с мыслями и наблюдениями</p></div></div></div></div></div><div class=content><div id=e2-note-6 class=e2-note><article><h1 class="e2-published e2-smart-title"><a href=https://blog.apatin.ru/p/nginx_for_frontenders/>nginx for frontenders</a></h1><div class="e2-note-text e2-text e2-published"><p>Очень часто бывает, что фронтенд-разработчику необходимо добавить или изменить функционал сайта, но нет возможности получить его dev-версию, на которую можно повлиять. Обычно это пытаются обойти запуском браузера с отключенной безопасностью, но не всегда это помогает.</p><p>Я расскажу как при работе с «чёрным ящиком» иметь возможность воздействать на его ответы, а также как решать проблемы связанные с безопасностью.</p><h2 id=собираем-nginx-cnbspнеобходимыми-модулями>Собираем nginx c необходимыми модулями</h2><p>Для этого нам понадобится nginx и несколько вспомогательных модулей для него:</p><p><a href=https://github.com/openresty/headers-more-nginx-module target=_blank rel=nofollow>Module ngx_headers_more</a>, модуль для замены заголовков. Почему не использовать add_header, спросите вы, потому что он добавляет заголовок, даже если он уже был.</p><p><a href=http://nginx.org/en/docs/http/ngx_http_sub_module.html target=_blank rel=nofollow>Module ngx_http_sub_module</a>, позволит нам подменить строки в ответе источника.</p><h2 id=сборка>Сборка</h2><p>Для ubuntu собрать nginx ну очень просто, поэтому опишу как это сделать под OS X.</p><pre><code>sudo mkdir -p /usr/local/src

cd /usr/local/src
</code></pre><p>pcre можно поставить из brew или собрать самостоятельно</p><pre><code>sudo wget http://ftp.cs.stanford.edu/pub/exim/pcre/pcre-8.38.tar.gz

sudo tar xzvf pcre-8.38.tar.gz

cd pcre-8.38

sudo ./configure --prefix=/usr/local

sudo make &amp;&amp; sudo make install &amp;&amp; sudo make clean

cd .

sudo wget http://nginx.org/download/nginx-1.10.0.tar.gz

sudo wget https://github.com/openresty/headers-more-nginx-module/archive/v0.30rc1.tar.gz

sudo tar xzvf nginx-1.10.0.tar.gz

sudo tar xzvf v0.30rc1.tar.gz

cd&amp;nbsp;nginx-1.10.0

sudo./configure --prefix=/usr/local --with-http_sub_module --add-module=/usr/local/src/headers-more-nginx-module-0.30rc1

sudo make &amp;&amp; sudo make install &amp;&amp; sudo make clean

nano ~/.bash_profile

export PATH=&quot;/usr/local/sbin: $PATH&quot;

. ~/.bash_profile
</code></pre><p>Здесь показана сборка без поддержки SSL, поэтому не получится работать с сайтами, которые работают только по HTTPS.</p><h2 id=проверяем-работоспособность-nginx>Проверяем работоспособность nginx</h2><pre><code>sudo nginx -t
</code></pre><p>Конфиг nginx будет лежать по этому пути /usr/local/conf/nginx.conf</p><p>Релоад конфига выполняется</p><pre><code>sudo nginx -s reload
</code></pre><h2 id=nginx-готов-можно-приступать>Nginx готов, можно приступать!</h2><p>Предположим, мы хотим повлиять на vk.com</p><p>Пропишем наш тестовый домен:</p><pre><code>sudo nano /etc/hosts

127.0.0.1 test.vk.com
</code></pre><p>Начнём писать наш конфиг. Чтобы было сложнее запутаться, сделаем конфиг в виде инклюдов. В итоге, наш конфиг будет выглядеть как:</p><p>site.conf — в котором будет общее описание сайта и инклюды следующих частей</p><p>proxy_site.conf — здесь мы опишем какая часть запросов пойдёт на сам сайт, а какая будет завернуть к нам</p><p>proxy_api.conf — тут будут настройки проксирования для api, если нужно</p><p>headers.conf — заголовки для подмены, отключим все лишнее, что возвращает backend</p><p>sub_filter.conf — список замен для данных, которые будет возвращать backend</p><p>затем, редактируем /usr/local/conf/nginx.conf</p><p>добавляем в конец секции http путь до нашего основного инклюда</p><p>include /Users/{USERNAME}/nginx_test/site.conf;</p><p>Затем, меняем /Users/{USERNAME}/nginx_test/site.conf;</p><p>который в свою очередь описывает какой домен мы будем обрабатывать</p><pre><code>server {
    listen 80;
    server_name &amp;nbsp;test.vk.com;
    include /Users/{USERNAME}/nginx_test/proxy_site.conf;
    include /Users/{USERNAME}/nginx_test/sub_filter.conf;
    include /Users/{USERNAME}/nginx_test/headers.conf;
}
</code></pre><p>Сделаем проксипасс до нужного сервера в /Users/{USERNAME}/nginx_test/proxy_site.conf;</p><pre><code>location / {
    proxy_set_header Accept-Encoding &quot;&quot;; # это важный параметр, если его не указать, то для gzip сайтов не будет работать замена
    proxy_pass http://vk.com;
}
</code></pre><p>Для примера покажу, как сделать так, чтобы про браузер не знал про vk.com и думал, что он теперь test.vk.com</p><p>затем редактируем /Users/{USERNAME}/nginx_test/sub_filter.conf;</p><p>sub_filter &lsquo;vk.com&rsquo; &lsquo;test.vk.com&rsquo;; # указыват, какую строку и на что мы заменяем (с версии nginx 1.9.4 можно делать замену разных строк дублируя вызов этой команды)</p><pre><code>sub_filter_once off; # говорит, что нужно сделать несколько замен, а не только одну

sub_filter_types *; # для каких типов документов выполнять замену, по умолчанию только для html

sub_filter_last_modified on; # менять заголовок, если была произведена замена
</code></pre><h2 id=подмена-домена-наnbspкоторый-ставится-кука>Подмена домена, на который ставится кука</h2><p>proxy_cookie_domain &lsquo;vk.com&rsquo; &lsquo;test.vk.com&rsquo;;</p><h2 id=заголовки-ответа-сервера>Заголовки ответа сервера</h2><p>Осталось подменить заголовки, влияющие на безопасность, редактируем /Users/{USERNAME}/nginx_test/headers.conf;</p><pre><code>more_clear_headers 'Access-Control-*'; # можем удалить заголовки из ответа
more_set_headers 'Access-Control-Allow-Origin: http://test.vk.com'; # или поменять их
</code></pre></div></article><div class=e2-note-tags><span class=e2-timestamp>26.04.2016</span> &nbsp;
<a href=https://blog.apatin.ru/t/%D1%82%D0%B5%D1%85%D0%BD%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B5 class=e2-tag>техническое</a> &nbsp;
<a href=https://blog.apatin.ru/t/%D0%BA%D0%BE%D0%B4 class=e2-tag>код</a> &nbsp;
<a href=https://blog.apatin.ru/t/nginx class=e2-tag>nginx</a> &nbsp;
<a href=https://blog.apatin.ru/t/frontent class=e2-tag>frontent</a> &nbsp;</div></div><div class=e2-pages><a href=https://blog.apatin.ru/p/monit/>Ранее</a>
<span class=e2-keyboard-shortcut>↓</span>
<span class=e2-keyboard-shortcut>⌥</span>
<span class=e2-keyboard-shortcut>↑</span>
<a href=https://blog.apatin.ru/p/postgres_install/>Позднее</a></div><h4 class=page-header>Рекомендуемые посты:</h4><div id=e2-note-6><a href=https://blog.apatin.ru/p/how-cloudflare-protect-email/><h5 class="e2-published e2-smart-title" style=font-size:18px>Как Cloudflare защищает email</h5></a><div class=e2-note-tags><span class=e2-timestamp>26.04.2020</span></div></div><br><div id=e2-note-6><a href=https://blog.apatin.ru/p/github-actions-go-release/><h5 class="e2-published e2-smart-title" style=font-size:18px>Github Actions и автоматическое создание релизов на Go</h5></a><div class=e2-note-tags><span class=e2-timestamp>27.09.2019</span></div></div><br></div><div class=footer>&copy;
<span id=e2-blog-author>Daniel Apatin</span>,
2008—2021
<a href=https://blog.apatin.ru/rss.xml type=application/rss+xml target=_blank class=e2-rss-button>RSS</a>
<a class=e2-rss-button href=https://blog.apatin.ru/tags/>Теги</a></div></div><script type=text/javascript>(function(d,w,c){(w[c]=w[c]||[]).push(function(){try{w.yaCounter21943429=new Ya.Metrika({id:21943429,webvisor:true,clickmap:true,accurateTrackBounce:true});}catch(e){}});var n=d.getElementsByTagName("script")[0],s=d.createElement("script"),f=function(){n.parentNode.insertBefore(s,n);};s.type="text/javascript";s.async=true;s.src=(d.location.protocol=="https:"?"https:":"http:")+"//mc.yandex.ru/metrika/watch.js";if(w.opera=="[object Opera]"){d.addEventListener("DOMContentLoaded",f,false);}else{f();}})(document,window,"yandex_metrika_callbacks");document.addEventListener("DOMContentLoaded",function(){var lazyImages=[].slice.call(document.querySelectorAll("img.lazy"));if("IntersectionObserver"in window){let lazyImageObserver=new IntersectionObserver(function(entries,observer){entries.forEach(function(entry){if(entry.isIntersecting){let lazyImage=entry.target;lazyImage.src=lazyImage.dataset.src;lazyImage.classList.remove("lazy");lazyImageObserver.unobserve(lazyImage);}});});lazyImages.forEach(function(lazyImage){lazyImageObserver.observe(lazyImage);});}else{}});Array.from(document.getElementsByClassName("__email__")).forEach(function(l,index,array){var a=l.getAttribute("data-class");if(a){var s='';var r=parseInt(a.substr(0,2),16);for(var j=2;a.length-j;j+=2){var c=parseInt(a.substr(j,2),16)^r;s+=String.fromCharCode(c);}
l.parentNode.href="mailto:"+s;l.parentNode.innerText=s;}});</script></body><ok></html>