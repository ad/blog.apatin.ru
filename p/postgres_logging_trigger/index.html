<!doctype html><html lang=ru class=no-js lang><head><meta charset=utf-8><title>Логирование изменений в Postgresql — Weblog</title><meta name=og:title content="Логирование изменений в Postgresql — Weblog"><meta name=description content="Логирование изменений в Postgresql"><meta name=og:description content="Логирование изменений в Postgresql"><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=5"><meta property="og:image" content="/static/apple-touch-icon.png"><link rel="shortcut icon" href=https://blog.apatin.ru/static/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=https://blog.apatin.ru/static/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://blog.apatin.ru/static/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://blog.apatin.ru/static/favicon-16x16.png><link rel=icon href=https://blog.apatin.ru/static/favicon.svg type=image/svg+xml><link rel=stylesheet href=https://blog.apatin.ru/css/main.min.e3af6c263c819bedfd8ba2c0d4f375f1b790ede6fa1a937e2807998f466c1da0.css integrity="sha256-469sJjyBm+39i6LA1PN18beQ7eb6GpN+KAeZj0ZsHaA=" media=screen><link rel=prev id=link-earlier href=https://blog.apatin.ru/p/postgres_update_trigger/><link rel=next id=link-later href=https://blog.apatin.ru/p/postgresql_reload/><meta name=yandex-verification content="975872b19b152cad"><meta name=yandex-verification content="449579cc5ed55017"></head><body><div class=common><div class=flag><div class=header-content><div class=header-description><div class=title><div class=title-inner><div class=logo-marginal><div class=e2-user-picture-container><img alt=Logo title=Logo src=https://blog.apatin.ru/static/favicon.png></div></div><h1><a href=https://blog.apatin.ru/><span id=e2-blog-title style=font-size:48px>Weblog</span></a></h1></div><div id=e2-blog-description><p>Личный блог с мыслями и наблюдениями</p></div></div></div><div class=spotlight><form id=e2-search class="search-field search-field-right-anchored e2-enterable" action=https://blog.apatin.ru/search accept-charset=utf-8 name=searchForm role=form onsubmit=return!1><label class=search-field__label><input class=search-field__input type=text autocomplete=off placeholder="Search site" id=search aria-label="Search site" name=q><div class=search-field__zoom-icon><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 16 16"><path stroke="none" fill-rule="evenodd" clip-rule="evenodd" d="M16 14.5l-4.399-4.399a6.212 6.212.0 001.148-3.602 6.25 6.25.0 10-12.5.0 6.25 6.25.0 006.251 6.25 6.212 6.212.0 003.602-1.148L14.5 16l1.5-1.5zM1.25 6.501a5.251 5.251.0 1110.502.0 5.251 5.251.0 01-10.502.0z"/></svg></div><a class="nu search-field__tags-icon" href=https://blog.apatin.ru/tags/ title=Теги><span class=e2-svgi><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 16 16"><path stroke="none" d="M6.938 16.001c-.43.0-.891-.16-1.32-.59L.607 10.38C-.406 9.367.037 8.191.581 7.647l6.538-6.501C7.145 1.116 8.176.0 9.427.0h4.044c1.153.0 2.5.659 2.5 2.516v3.991c0 1.167-1.029 2.229-1.146 2.347L8.32 15.415c-.308.309-.818.586-1.382.586zM9.427 1c-.801.0-1.578.828-1.586.837L1.287 8.354c-.146.152-.587.706.027 1.319l5.011 5.031c.589.59 1.137.15 1.29.003l6.501-6.559c.238-.241.855-1.002.855-1.642v-3.99c0-1.318-.94-1.516-1.5-1.516H9.427zm1.571 5.754c-.468.0-.907-.183-1.238-.515a1.765 1.765.0 010-2.487c.661-.664 1.814-.664 2.475.0.331.332.513.774.513 1.243s-.182.911-.513 1.243a1.73 1.73.0 01-1.237.516z"/></svg></span></a></label></form></div></div></div><section class=search-results style=display:none><div class=content></div></section><div class=content id=content><div id=e2-note-6 class=e2-note><article><h1 class="e2-published e2-smart-title"><a href=https://blog.apatin.ru/p/postgres_logging_trigger/>Логирование изменений в Postgresql</a></h1><div class="e2-note-text e2-text e2-published"><p>Иногда нужно добавить логирование изменений в некоторых таблицах, для этого приходится городить сложную систему, которая будет отслеживать изменения и записывать в нужное место что поменялось, и есть большой риск забыть добавить логирование в каком-то месте, эту проблему можно изящно решить сделав триггер на изменение таблицы (весь исходный код доступен на (github)[https://gist.github.com/ad/24b606793aa73e8fd5bf1fe4a89c9507] или можно скопировать нажав на кнопку).</p><p>Создаем таблицу, в которой будут храниться изменения:
<input type=button value=&#x2398 title="Копировать код" onclick="return copyToClipboard('create_table'),!1">
<input type=hidden id=create_table value="CREATE TABLE history (
    id          serial,
    tstamp      timestamp DEFAULT now(),
    schemaname  text,
    tabname     text,
    operation   text,
    who         text DEFAULT current_user,
    new_val     json,
    old_val     json,
    item_id     int8
);"><figure><noscript><style>img.lazy{display:none}</style><img src=https://blog.apatin.ru/images/CREATE_TABLE_history.png width=375px alt="Создаем таблицу"></noscript><img class=lazy style=max-width:100% sizes="(max-width: 320px) 280px, (max-width: 480px) 440px, 800px" src="data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAhCAYAAACfiCi5AAAEFklEQVR4nLRZbbLcKAxUuzjPXmGvsPe/yf7qlEECfdkzL5VQUy82BtHdkrBFxj///vc/QIjMH2Re6N1qoOy2u+k6fXvong8en7mZapeNSU4buH9mDRwZPDCH4gC+O2XO9BaBHrhnGwA7RXry6ynATBa2pNzgKYp4DsQw8Ft2A49oWAnWRU2LNDz0bUAU8eRbrxgesnm+SKypuEmMHTZQhIdBIpLQpS6H9XQbgK0+nPr84BULDN7PcEyvcFj6iwyLGpA4kaSdB4oXU/wzZg4+hE7GbIBHfbih7LxiQltYWXBtLW6tx1kqg0dQqEidGyM5Bi/g9JNeYO1zti0CQvhobG8SYnA5lvLHxyY9jvDICdvGDZrbO4xTmMAxZMoJ0tleREA6hzQkhsZ+DPtDIvgg3YWA70KJgAPPCNTC9QORuUvuCAwk5tDhExiRBJInSmMmZOp75XdoWQIvIqQXBWGn0q1cHOg7DTKJmSDDbZOWBWg88ZoD1HSmvgdMefLE9AoffcVQ93vJRCwfaDgDibMXHxLXgTFXTW+0vUetNLmHrIs1XN2GTR7uXv8NIoggCLLseWngPwjSJuI29v3w0lWPeQMoByxw5sQhCAQF2Ws+LBHe3kio0eZaJlEyEpfEr4ZkAQeALnKy5Sy6yWw8CCZRkTUkpJCo1zXpLu+UloQPJeeRrHhBtN/skshEBJBnEih/65wrWXfx4SbXF4FkKdEiemh42Zo/Tw4TrhaQ7GwqQHc/KpBq5w3awzPvhZQLXbvejTpP5ID9FtBfblftyp74ZOJ3gf+0IupXuv6Umt26b9WZv87j+DCz6208UGexmU2JH2RiX11hPMv8UDFm8JWJ1AoztvGIWr1gVyw3rlhtUPQeiYg78E/qt1Xy8sDjlA2MzKuygP+kfgDPRFqfM7HzUrCnLcNKHG7J6fZ/rmIkFSJZLe6jhAy6gs/eKqXkQ6g9DRneln4m4hiHfmUilXws1/TnISEfOvBfApecJxQmN409HvZRbL9VEVA/ffOCDED8pzFdWOUkZt0Q+BAeZXciS9Lw9sAU+pQm0BDSOkhJ5G2VWZUEmFFRpm9/SZ6suLJULBuF/oYGiElz1z6yzzEmCcBliLfpctKHCStwJy67U632fIhZn8Dc+oYs8OAKIYKHhLi6ql/U+aGAjeFSTqneQEvcxJ7Az6NFrsRdR3b7epHYRwLqhLxISMovgccc6PB1bYege7wKzqFrYB2a3oU3rRo91Qo7L2SJvgVeUvOpMa1DD9xWGDc4Ws0MO7Jb7mCUvl+lROhn4C+gI/60F3iLqug8VrlDZR1vUU8daSfW4Zxvb7atVJnIz9T2lsqGGQZwH+esEKK9bCeJtWfCTnbmn/UK69873Yb3U+AhUl4G9P8/8CsAAP//brq6OLWtuy0AAAAASUVORK5CYII=" data-srcset="https://blog.apatin.ru/images/CREATE_TABLE_history.png 750w, https://blog.apatin.ru/images/CREATE_TABLE_history_hu17119e75bfad9e0b4e7ee3cb49b95e87_47659_280x0_resize_q75_h2_box_2.webp 320w, https://blog.apatin.ru/images/CREATE_TABLE_history_hu17119e75bfad9e0b4e7ee3cb49b95e87_47659_440x0_resize_q75_h2_box_2.webp 480w" data-src=https://blog.apatin.ru/images/CREATE_TABLE_history.png width=375px alt="Создаем таблицу"></figure></p><p>Создаем функцию, которая будет записывать изменения:
<input type=button value=&#x2398 title="Копировать код" onclick="return copyToClipboard('create_or_replace'),!1">
<input type=hidden id=create_or_replace value="CREATE OR REPLACE FUNCTION change_trigger() RETURNS trigger AS $$
BEGIN
  IF TG_OP = 'INSERT'
    THEN
      INSERT INTO history (tabname, schemaname, operation, new_val, item_id)
      VALUES (TG_RELNAME, TG_TABLE_SCHEMA, TG_OP, row_to_json(NEW), NEW.id);
      RETURN NEW;
ELSIF TG_OP = 'UPDATE'
  THEN
    INSERT INTO history (tabname, schemaname, operation, new_val, old_val, item_id)
    VALUES (TG_RELNAME, TG_TABLE_SCHEMA, TG_OP, row_to_json(NEW), row_to_json(OLD), NEW.id);
    RETURN NEW;
  ELSIF TG_OP = 'DELETE'
    THEN
      INSERT INTO history (tabname, schemaname, operation, old_val, item_id)
      VALUES (TG_RELNAME, TG_TABLE_SCHEMA, TG_OP, row_to_json(OLD), OLD.id);
      RETURN OLD;
  END IF;
END;
$$ LANGUAGE 'plpgsql' SECURITY DEFINER;"><figure><noscript><style>img.lazy{display:none}</style><img src=https://blog.apatin.ru/images/CREATE_OR_REPLACE_FUNCTION.png width=600px alt="Создаем функцию"></noscript><img class=lazy style=max-width:100% sizes="(max-width: 320px) 280px, (max-width: 480px) 440px, 800px" src="data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAdCAYAAADsMO9vAAADTElEQVR4nKyYiY2cQBBF6yPicQqOwfmnYulbQBV1ds96tWjGZvri/bro3vPX7z9/BYQIBJDrwvuPINz4Rcry2nSNgzh1MN55nz43TuF5wUNBHTdRp//o3SMTPijhO4hSboXvo2jtcC2XgW8RiI87E/wjxS8gsbK6wtp5zSvEmDUgq3jmo4rR1UD9rEWcE3zEfuJpbXL3CGrX2hsXRPrp3hUTQ/UIVA7dZ1HEaYGOAKs8KQGy9TG7wsaxUKPqgHEmQY8HgvXF8uGCIjGIuEMIbnoTUYyKOXSKlZkqAJrxHZo5xIh3NBGFPOOwEXG+eVPgk4KcGFmBM0jNF/NznWqtr6cQoG5AA0+5MIo4U+VUEfCfHTpaH90TZJiB4gVGfEt0mAb3gOWEg1cRqvJKYuWGILkfngiNnyGkGELDRbGLCWuzijEPaDUjzDFoIqxKAQQpPKS8qhDhkdtFv6HZPQYJ7ToOz7cawOfkGdaBwhNrBvI6OFKzZ7PEO4NA+NrvYtyxQPka2ApBmtFpy9v2/hwxT5E1xEoq9dEIVi5v7iYuM/SOVi9K+EIwMDzX0SqOoyVhBj0VVAdDflv8h4g4oZbitkKw1DEOagFX3FS729QF4EbEfsZ60PHlFSL4l5723Wu1+Nx+zINa9vzoZS+51lbuhlntOr4NsO3ru/nUvzpQrKctO84d6KfJTFB9UJ2ytXydP6w3ESwF2PaA6b27WLIelTjAD1af4KMxOK6VG8537874SudT39+2fpRh2S6s4DmoWYJX+ALNYf5pRqbuYZq1WfY3A+gMzxbqU6hxGJDXi89lehj1QCNpQ0nRzRTfk9mUcz3+s0SO4TyAZ6DUxrRwM6DuRq8tHZRY97L3Plyb1m9Ej+sUMg18Dz2110pWwpVR7PmaPvjglqQi6vFwriz7uN/H9w5cqkdZQ/MMyB4/0Jt7YN9eNisPYSND6HQPtJ4uhsUXJWlO8gn2+3TwnnxUAfS4vcmBuWR+gp7LUvPzB/gL+dQH8jnkqAihvQTW8S9tsaXABt2Am8ImZoKXOwfuMnk1wEUA0Yd9gzk7pRQaDiVykU2jIJkNH+BF/7ClQaQdV+3MJ3P6QXYCXtpxTs4tsNTwaX5lsgv4LwAA//9OhyEymeBwcQAAAABJRU5ErkJggg==" data-srcset="https://blog.apatin.ru/images/CREATE_OR_REPLACE_FUNCTION.png 1200w, https://blog.apatin.ru/images/CREATE_OR_REPLACE_FUNCTION_hu867eb3b34f09e19c80972e1c393d5f31_120052_280x0_resize_q75_h2_box_2.webp 320w, https://blog.apatin.ru/images/CREATE_OR_REPLACE_FUNCTION_hu867eb3b34f09e19c80972e1c393d5f31_120052_440x0_resize_q75_h2_box_2.webp 480w, https://blog.apatin.ru/images/CREATE_OR_REPLACE_FUNCTION_hu867eb3b34f09e19c80972e1c393d5f31_120052_800x0_resize_q75_h2_box_2.webp 800w" data-src=https://blog.apatin.ru/images/CREATE_OR_REPLACE_FUNCTION.png width=600px alt="Создаем функцию"></figure></p><p>Вешаем триггер на нужные таблицы:
<input type=button value=&#x2398 title="Копировать код" onclick="return copyToClipboard('create_trigger'),!1">
<input type=hidden id=create_trigger value="CREATE TRIGGER tablename_trigger BEFORE INSERT OR UPDATE OR DELETE ON tablename FOR EACH ROW EXECUTE PROCEDURE change_trigger();"><figure><noscript><style>img.lazy{display:none}</style><img src=https://blog.apatin.ru/images/CREATE_TRIGGER.png width=600px alt="Вешаем триггер"></noscript><img class=lazy style=max-width:100% sizes="(max-width: 320px) 280px, (max-width: 480px) 440px, 800px" src=data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAICAYAAAC/K3xHAAAAw0lEQVR4nMxU7a3DMAjkoqzzZngrdP9ZKlHZqYPDp/2vSK3PGB9cCDn//l9vIhARA20h+RsQX8RUmAnge+E8MKJi5WCB6KznXSueBJMY8bm7KYdx4drgSie1oBQRUSnYBNhrWoxS5TAPJBlY1xcUUFkeCzpIPVk4qEPTounn3YbD84hEcJIYLDx2OSri1L1dcW1dwNyi1db+iq11oFIVnEcfpVXajNAMcRu68d72AYTq+HAuZpAhtmXyRvl5FNMnAAD//8gvN9zpLFLyAAAAAElFTkSuQmCC data-srcset="https://blog.apatin.ru/images/CREATE_TRIGGER.png 1200w, https://blog.apatin.ru/images/CREATE_TRIGGER_hua7b4c857ca019d1f1eacee77b4ba7563_24319_280x0_resize_q75_h2_box_2.webp 320w, https://blog.apatin.ru/images/CREATE_TRIGGER_hua7b4c857ca019d1f1eacee77b4ba7563_24319_440x0_resize_q75_h2_box_2.webp 480w, https://blog.apatin.ru/images/CREATE_TRIGGER_hua7b4c857ca019d1f1eacee77b4ba7563_24319_800x0_resize_q75_h2_box_2.webp 800w" data-src=https://blog.apatin.ru/images/CREATE_TRIGGER.png width=600px alt="Вешаем триггер"></figure></p></div></article><div class=e2-note-tags><span class=e2-timestamp>26.05.2015</span> &nbsp;
<a href=https://blog.apatin.ru/t/%D1%82%D0%B5%D1%85%D0%BD%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B5 class=e2-tag>техническое</a> &nbsp;
<a href=https://blog.apatin.ru/t/%D0%BA%D0%BE%D0%B4 class=e2-tag>код</a> &nbsp;
<a href=https://blog.apatin.ru/t/%D0%BF%D0%BE%D0%BB%D0%B5%D0%B7%D0%BD%D0%BE%D0%B5 class=e2-tag>полезное</a> &nbsp;
<a href=https://blog.apatin.ru/t/postgres class=e2-tag>postgres</a> &nbsp;
<a href=https://blog.apatin.ru/t/logging class=e2-tag>logging</a> &nbsp;
<a href=https://blog.apatin.ru/t/trigger class=e2-tag>trigger</a> &nbsp;</div></div><div class=e2-pages><a href=https://blog.apatin.ru/p/postgres_update_trigger/>Ранее</a>
<span class=e2-keyboard-shortcut>↓</span>
<span class=e2-keyboard-shortcut>⌥</span>
<span class=e2-keyboard-shortcut>↑</span>
<a href=https://blog.apatin.ru/p/postgresql_reload/>Позднее</a></div><h4 class=page-header>Рекомендуемые посты:</h4><div id=e2-note-6><a href=https://blog.apatin.ru/p/airtag-emulation-with-nrf51822/><h5 class="e2-published e2-smart-title" style=font-size:18px>Эмуляция Apple Airtag при помощи nRF51822 iBeacon</h5></a><div class=e2-note-tags><span class=e2-timestamp>03.05.2021</span></div></div><br><div id=e2-note-6><a href=https://blog.apatin.ru/p/to-gh-pages/><h5 class="e2-published e2-smart-title" style=font-size:18px>Переезд на Github Pages</h5></a><div class=e2-note-tags><span class=e2-timestamp>31.01.2021</span></div></div><br></div><div class=footer>&copy;
<span id=e2-blog-author>Daniel Apatin</span>,
2008—2021
<a href=https://blog.apatin.ru/rss.xml type=application/rss+xml target=_blank class=e2-rss-button>RSS</a>
<a class=e2-rss-button href=https://blog.apatin.ru/tags/>Теги</a></div></div><noscript><div><img src=https://mc.yandex.ru/watch/21943429 style=position:absolute;left:-9999px alt></div></noscript><script type=text/javascript>document.addEventListener("DOMContentLoaded",function(){var a=[].slice.call(document.querySelectorAll("img.lazy"));if("IntersectionObserver"in window){let b=new IntersectionObserver(function(a,c){a.forEach(function(a){if(a.isIntersecting){let c=a.target;c.src=c.dataset.src,c.classList.remove("lazy"),b.unobserve(c)}})});a.forEach(function(a){b.observe(a)})}}),Array.from(document.getElementsByClassName("__email__")).forEach(function(b,h,g){var a=b.getAttribute("data-class"),c,f,d,e;if(a){c='',f=parseInt(a.substr(0,2),16);for(d=2;a.length-d;d+=2)e=parseInt(a.substr(d,2),16)^f,c+=String.fromCharCode(e);b.parentNode.href="mailto:"+c,b.parentNode.innerText=c}});let fired=!1;window.addEventListener('scroll',function(){fired===!1&&(fired=!0,setTimeout(()=>{(function(a,e,f,g,b,c,d){a[b]=a[b]||function(){(a[b].a=a[b].a||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,"script","https://mc.yandex.ru/metrika/tag_jet_beta.js","ym"),ym(21943429,"init",{clickmap:!0,trackLinks:!0,accurateTrackBounce:!0,ecommerce:"dataLayer"})},500))},{passive:!0});let searchFired=!1;var searchEl=document.getElementsByClassName("search-field__zoom-icon")[0];searchEl.addEventListener('click',function(){searchFired===!1&&(searchFired=!0,setTimeout(()=>{var a=document.createElement('script');a.type='text/javascript',a.src='https://blog.apatin.ru/js/search.min.js',document.getElementsByTagName('body')[0].appendChild(a)},500))},{passive:!0});function copyToClipboard(b){var c=document.getElementById(b).value;const a=document.createElement('textarea');a.value=c,a.setAttribute('readonly',''),a.style.position='absolute',a.style.left='-9999px',document.body.appendChild(a),a.select(),document.execCommand('copy'),document.body.removeChild(a)}</script></body><ok></html>